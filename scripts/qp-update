#!/bin/bash
# qp-update - HH Quick Provisioner Update Script
# Install to /usr/local/bin/qp-update with: sudo cp scripts/qp-update /usr/local/bin/ && sudo chmod +x /usr/local/bin/qp-update
# Usage: sudo qp-update

set -e  # Exit on error
set -u  # Exit on undefined variable

MODULE_DIR="/var/www/html/admin/modules/quickprovisioner"
WEB_USER="asterisk"
WEB_GROUP="asterisk"
GIT_SSH_KEY="/home/hhvoip/.ssh/id_github"

echo "========================================"
echo " HH Quick Provisioner - Update Script"
echo "========================================"

cd "$MODULE_DIR" || exit 1

CURRENT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
echo "Current commit: $CURRENT_COMMIT"

if [ -f "$GIT_SSH_KEY" ] && [ -r "$GIT_SSH_KEY" ]; then
    export GIT_SSH_COMMAND="ssh -i $GIT_SSH_KEY -o IdentitiesOnly=yes -o StrictHostKeyChecking=accept-new"
fi

echo ""
echo "Fetching updates from GitHub..."
git fetch origin 2>&1

LOCAL=$(git rev-parse HEAD 2>/dev/null || echo "")
REMOTE=$(git rev-parse origin/main 2>/dev/null || git rev-parse origin/master 2>/dev/null || echo "")

UPDATES_APPLIED=0

if [ -z "$LOCAL" ] || [ -z "$REMOTE" ]; then
    echo "Error: Could not determine commit hashes"
    exit 1
fi

if [ "$LOCAL" = "$REMOTE" ]; then
    echo "Already up to date!"
else
    echo "Pulling updates..."
    git pull origin main 2>&1 || git pull origin master 2>&1
    NEW_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
    echo "Updated: $CURRENT_COMMIT -> $NEW_COMMIT"
    UPDATES_APPLIED=1
fi

echo ""
echo "Fixing permissions..."
chown -R "$WEB_USER:$WEB_GROUP" "$MODULE_DIR"
find "$MODULE_DIR" -type f -exec chmod 644 {} \;
find "$MODULE_DIR" -type d -exec chmod 755 {} \;
chmod 775 "$MODULE_DIR/templates" "$MODULE_DIR/assets" "$MODULE_DIR/assets/uploads" 2>/dev/null || true
chmod g+s "$MODULE_DIR/templates" "$MODULE_DIR/assets" "$MODULE_DIR/assets/uploads" 2>/dev/null || true

echo "Fixing FreePBX admin directory permissions..."
chown -R "$WEB_USER:$WEB_GROUP" /var/www/html/admin 2>/dev/null || true

echo "Fixing Asterisk runtime permissions..."
if [ -d /var/run/asterisk ]; then
    chown -R "$WEB_USER:$WEB_GROUP" /var/run/asterisk 2>/dev/null || true
    chmod 755 /var/run/asterisk 2>/dev/null || true
    if [ -S /var/run/asterisk/asterisk.ctl ]; then
        chmod 660 /var/run/asterisk/asterisk.ctl 2>/dev/null || true
    fi
fi

VERSION=$(grep -oP '(?<=<version>)[^<]+' "$MODULE_DIR/module.xml" 2>/dev/null | head -1 || echo "unknown")

if [ "$UPDATES_APPLIED" -eq 1 ]; then
    echo ""
    echo "Running FreePBX chown to fix all file permissions..."
    fwconsole chown || echo "Warning: fwconsole chown failed"
    echo ""
    echo "Restarting FreePBX..."
    if fwconsole restart; then
        echo "FreePBX restarted successfully."
    else
        echo "Warning: FreePBX restart failed. Please restart manually."
    fi
    echo ""
fi

echo ""
echo "========================================"
echo " Done! Version: $VERSION"
echo "========================================"
